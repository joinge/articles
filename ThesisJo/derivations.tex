
\newpage

\section{Wave Equation}

The wave equation describes how a wave moves as a function of both time and space. It forms the basis for all mathematical modeling of waves, so we will spend some time to derive it here. We will treat acoustical waves since they are most relevant to the topic in this thesis, but we could have derived it from electromagnetic waves using Maxwell's equations with some boundary conditions.

\begin{figure}[ht]
\begin{floatrow}

\floatbox{figure}[\linewidth][\FBheight][t]{%
\caption{Mass flow}}{%
\graphicsAI[drawing,width=.77\linewidth]{gfx/wave_equation_mass_flow.svg}}%

\floatbox{table}[\linewidth][\FBheight][t]{%
\caption{Symbol description}}{%
\begin{tabular}[c]{c c l}\hline
\rowcolor{tabBlue}\bf Symbol & \bf Unit & \bf Description \\\hline
$s$ & Pa = N/m$^2$ & Pressure \\
$\rho$ & kg/m$^3$ & Density \\
$S$ & Nm/K & Entropy \\
$\vec v$ & m/s & Mass velocity \\
$\dot{\boldsymbol{m}}$ & kg/s & Mass flow
\end{tabular}}

\end{floatrow}
\end{figure}


We begin by defining the net \textbf{mass flow} through a volumetric element $dV = dx\,dy\,dz$:
%
\begin{align}
\frac{\dot{\boldsymbol{m}}_\text{net}}{dV} = \ux\frac{\partial \rho\,\v}{\partial x} + \uy\frac{\partial \rho\,\v}{\partial y} + \uz\frac{\partial \rho\,\v}{\partial z} = \nabla \cdot (\rho\v).
\end{align}
%
The space and time dependence of the mass density $\rho = \rho(\p,t)$ and particle velocity $\v = \v(\p,t)$ is omitted here and in the following text for brevity. If the volume of the element is fixed a change in mass must equal a corresponding change in density. This is the law of \textbf{mass conservation}:
%
\begin{align}
\frac{\partial\rho}{\partial t} = -\nabla \cdot (\rho\v). \label{wave_eq_mass_conservation}
\end{align}
%
An additional constraint we may surely apply is the Euler's equation, a modification of Newton's second law the the total acceleration $a$ is is a function of both time and space:
%
\begin{align}
\frac{F}{dV} = \frac{m}{dV} a = \rho\Big(\frac{\partial\v}{\partial t} + \v\cdot\nabla\v\Big) = -\nabla s. \label{wave_eq_euler}
\end{align}
%
Next, an \textbf{equation of state} is needed to relate a change in density to a change in pressure. We assume our volume element to be isentropic, i.e. that the entropy is constant, or equivalently that total energy of the system is proportional to its temperature. This is true for any system that is reversible and adiabatic, i.e. that when no transfer of matter or heat occurs between the system and its surroundings. The pressure of the system then just depends on the mass density:
%
\begin{align}
s = s(\rho) \label{wave_eq_sound_pressure}
\end{align}

With this we have assumed the system to be \emph{loss-less}. In reality a passing sound wave will heat the fluid and add to the entropy, causing additional attenuation of the wave, but we will not be concerned with attenuation in this thesis.

\subsection{Linearization}

Equation (\ref{wave_eq_mass_conservation}), (\ref{wave_eq_euler}) and (\ref{wave_eq_sound_pressure}) are non-linear, but can be linearized by assuming each quantity to be a steady-state, time-independent value plus a fluctuation term:
%
\begin{align}
s = s_0 + s'  \qquad\qquad \rho = \rho_0 + \rho' \qquad\qquad \v = \v_0 + \v'
\end{align}
%
Taylor expanding (\ref{wave_eq_sound_pressure}) around zero yields:
%
\begin{align}
s(\rho) = s_0 + \frac{\partial s}{\partial\rho}(\rho-\rho_0) + \frac{1}{2}\frac{\partial^2 s}{\partial\rho^2}(\rho-\rho_0)^2 + \dots\label{wave_eq_sound_taylor_full}
\end{align}
%
Assuming a linear relationship between changes in pressure and volume the pressure perturbation term is simply:
%
\begin{align}
s' = \frac{\partial s}{\partial\rho}(\rho-\rho_0) = \frac{\partial s}{\partial\rho}\rho' = c^2\rho'. \label{wave_eq_sound_taylor_first}
\end{align}
%
When treating the Euler equation the same way we obtain:
%
\begin{align}
-\nabla (s_0 + s') &= (\rho_0 + \rho') \Big(\frac{\partial(\v_0 + \v')}{\partial t} + (\v_0 + \v')\cdot\nabla(\v_0 + \v')\Big) \nn
-\nabla s' &= (\rho_0 + \rho') \Big(\frac{\partial\v'}{\partial t} + \v'\cdot\nabla\v'\Big) \nn
\end{align}
%
When acceleration mainly depends on time, and the pressure fluctuations are relatively small,
%
\begin{align}
\frac{\partial\v'}{\partial t} >> \v'\cdot\nabla\v' \qquad\qquad\text{and}\qquad\qquad \rho_0 >> \rho',
\end{align}
%
then
%
\begin{align}
-\nabla s' &= \rho_0 \frac{\partial\v'}{\partial t}.
\end{align}
%
Finally, for the mass conservation we have:
%
\begin{align}
\frac{\partial(\rho_0 + \rho')}{\partial t} &= -\nabla \cdot \big((\rho_0 + \rho')(\v_0 + \v')\big)\nn
\frac{\partial\rho'}{\partial t} &= -\rho_0\nabla \cdot \v'. \label{wave_eq_mass_conservation2}
\end{align}
%
This assumes that the density is constant inside the volume element.

\begin{align}
\nabla\cdot(-\nabla s') &= \nabla\cdot\Big(\rho_0 \frac{\partial\v'}{\partial t}\Big) &
\frac{\partial}{\partial t}\frac{\partial\rho'}{\partial t} &= \frac{\partial}{\partial t}\Big(-\rho_0\nabla \cdot \v'\Big)\nn
-\nabla^2 s' &= \rho_0 \nabla\cdot\frac{\partial\v'}{\partial t} &
\frac{\partial^2\rho'}{\partial t^2} &= \frac{1}{c^2}\frac{\partial^2 s}{\partial t^2} = -\rho_0\nabla\cdot\frac{\partial \v'}{\partial t}
\end{align}
%
and we can now see that
%
\begin{align}
\nabla^2 s' - \frac{1}{c^2}\frac{\partial^2 s'}{\partial t^2} = 0.
\end{align}
%
This is called the homogeneous lossless wave equation, because there is no source term. When our signal $s$ signifies pressure (N/m$^2$), this links time and space by means of mass flow rate (kg/(m$^3$s).

The inhomogeneous equation can be obtained in a similar way by including a source term. If we model the source as an injection of a volume of fluid, we can include it in the linearized continuity equation:
%
\begin{align}
\frac{\partial\rho'}{\partial t} &= -\rho_0\nabla \cdot \v' - \rho_0f(\p,t). \label{wave_eq_mass_conservation_source}
\end{align}
%
where $\rho_0f(\p,t)$ is the rate of mass change (in $\left[\frac{\text{kg}}{\text{m}^3\text{s}}\right]$) caused by the mass injection. Following the exact same procedure as before we obtain:
%
\begin{align}
\nabla^2 s' - \frac{1}{c^2}\frac{\partial^2 s'}{\partial t^2} = \rho_0\frac{\partial f(\p,t)}{\partial t}.
\end{align}
%

\section{Solution}

Instead of solving the wave equation directly, we will make a qualified guess that the solution takes the form of a complex exponential in both time and space. For rectangular coordinates this can be written as:
%
\begin{align}
s(\p,t) &= A\,e^{j(\omega t - \k\cdot\p)},
\end{align}
%
Inserting this into the wave equation yields:
%
\begin{align}
\nabla^2 s = \frac{\partial^2 s}{\partial x^2} + \frac{\partial^2 s}{\partial y^2} + \frac{\partial^2 s}{\partial z^2} &= \frac{1}{c^2}\frac{\partial^2 s}{\partial t^2} \nn
(-jk_x)^2 s + (-jk_y)^2 s + (-jk_z)^2 s &= \frac{(-j\omega)^2}{c^2} s \nn
k_x^2 + k_y^2 + k_z^2 &= |\k|^2 = \frac{\omega^2}{c^2} \\
|\k| &= \frac{\omega}{c}
\end{align}
%
This means that when we can assume the spatial and temporal frequency to be related directly by the sound speed, $|\k| = \frac{\omega}{c}$, then assuming a complex exponential to be a valid solution. Another solution of the wave equation is that of a spherical wave:
%
\begin{align}
s(r,t) &= \frac{A}{r}\,e^{j(\omega t - kr)}.
\end{align}

\section{Absorption}

Our derivation of the wave equation assumed no loss of energy. In practice the wave's energy is abosorbed through viscous losses, heat conduction losses and intermolecular losses. These are strongly dependent on frequency. The wave equation can be adapted to account for absorption by assuming a complex sound speed, which will lead to a solution to the wave equation with a real exponential term. In this thesis we will not concern ourselves 

\newpage
\section{Roughness}

For a plane monochromatic wave the Rayleigh roughness parameter is quantified by:
\begin{align}
\Delta\varphi = 2k\xi\cos\theta.
\end{align}
Here $\theta$ is the incidence angle, $k = \frac{2\pi}{\lambda}$ is the wavenumber of the incoming wave, $\xi$ is the distance from the scattering point to the mean surface plane, and $\Delta\varphi$ is the phase difference.

\begin{figure}[th]
\graphicsAI[drawing,width=\linewidth]{gfx/roughness.svg}
\end{figure}

To see how roughness affects the specular reflection we compute the mean reflected wave as
\begin{align}
<p> &= V\int\limits_{-\infty}^{\infty} e^{-j\Delta\varphi(\xi)} p(\xi) d\xi,
\end{align}
where $p(\xi)$ is the probability density function of $\xi$. If we assume normal distribution, we get:
\begin{align}
<p> &= V\int\limits_{-\infty}^{\infty} e^{-j2k\xi\cos\theta} \frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{\xi^2}{2\sigma^2}} d\xi \nn
&= \frac{V}{\sqrt{2\pi}\sigma} \int\limits_{-\infty}^{\infty} e^{-\frac{\xi^2}{2\sigma^2}-j2k\xi\cos\theta} d\xi &\Big|{\begin{matrix}\scriptscriptstyle\hspace{-0.64cm} a = \frac{1}{2\sigma^2}\\
\scriptscriptstyle b = -j2k\cos\theta\end{matrix}}\nn
&= A \int\limits_{-\infty}^{\infty} e^{-a\xi^2 + b\xi} d\xi \nn
&= A \int\limits_{-\infty}^{\infty} e^{-a(\xi - \frac{b}{2a})^2 - \frac{b^2}{4a}} d\xi \nn
&= A e^{\frac{-b^2}{4a}} \int\limits_{-\infty}^{\infty} e^{-a(\xi - \frac{b}{2a})^2} d\xi & \Big|_{y = \xi - \frac{b}{2a}}\nn
&= A e^{\frac{-b^2}{4a}} \int\limits_{-\infty}^{\infty} e^{-ay^2} dy & \Big|_{z = \sqrt{a} y}\nn
&= A e^{\frac{-b^2}{4a}}\frac{1}{\sqrt{a}} \int\limits_{-\infty}^{\infty} e^{-z^2} dz \nn
&= A e^{\frac{-b^2}{4a}}\sqrt{\frac{\pi}{a}} \nn
&= \frac{V}{\sqrt{2\pi}\sigma} \sqrt{\frac{\pi}{\frac{1}{2\sigma^2}}} e^{\frac{-(-j2k\cos\theta)^2}{4\frac{1}{2\sigma^2}}} \nn
&= V e^{-2k^2\sigma^2\cos^2\theta}
\end{align}
This reflection coefficient is valid when the Rayleigh parameter is small (i.e. small frequency and relief amplitude), and at grazing incidence. Conventional limit of validity is $\frac{\pi}{2}$, which corresponds to $\sigma = \frac{\lambda}{8\cos\theta}$ and a coherent loss of 10.7dB.



\section{LCA}

Let $\X[n]$ be the data received by an array, pre-steered to all pixels in the image, and $\w$ be the window applied to these spatial data. Then we defined the beamformer output $z$ as the weighted sum of the data:
%
\begin{align}
z[\w,n] = \w\H\X[n] = \sumb{m=0}{M-1} w_m x_m^*[n]
\end{align}
%
From a set of $P$ windows the LCA beamformer selects the window $p$ that yield the least output power:
%
\begin{align}
\argmin{p}{E\big\{|z|^2\big\}} = \argmin{p}{E\big\{|\w_p\H\X[n]|^2\big\}} \qquad\text{subject to}\qquad \w\H\a = 1
\end{align}
%
We can estimate $E\big\{|\w_p\H\X[n]|^2\big\}$ as
%
\begin{align*}
\sigma^2_{z_p}[n] = \frac{1}{N_k} \sumb{n'=n-K}{n+K} | z_p[n'] |^2
\end{align*}
%
To add some extra flexibility, we can also estimate the variance by a weighted combination of local pixels
%
\begin{align*}
\sigma^2_{z_p}[x,n] = \frac{1}{N_x N_k} \sumb{x'=x-X}{x+X} \sumb{n=n-K}{n+K} w_\text{prf}[x',n']\big| z_p[x',n'] \big|^2
\end{align*}
%
where $w_\text{prf}[x',n']$ is a normalized 2 dimensional weight function. 

Kaiser:
%
\begin{align*}
w[n] = \frac{I_0\big( \pi\alpha\sqrt{1-(\frac{2n}{N-1}-1)^2}\big)}{I_0(\pi\alpha)}
\end{align*}
%
where $I_0$ is a zeroth order modified Bessel function of the first kind.


\subsection{Tricks}

Now let us choose a trigonometric window function:
%
\begin{align}
\w = e^{j\phi_\theta[m]}\frac{1}{2\pi\alpha?}\big(\alpha + (1-\alpha)\sin\left(\frac{2\pi m}{M-1}\right)\big)
\end{align}
%
where $\phi_\theta[m] = \frac{2\pi}{\lambda}dm\sin\theta$. Inserting this yields:
%
\begin{align}
\w\H\x &= \sumb{m=0}{M-1} e^{j\phi_\theta[m]}\Big(\alpha + (1-\alpha)\sin\left(\frac{2\pi m}{M-1}\right)\Big) x_m^* \nn
&= \alpha\sumb{m=0}{M-1} e^{j\phi_\theta[m]} x_m^* + (1-\alpha)\sumb{m=0}{M-1} e^{j\varphi[m]}\sin\left(\frac{2\pi m}{M-1}\right) x_m^* \\
&= \alpha \a + (1-\alpha)\b
\end{align}
%
where:
%
\begin{align}
a = \sumb{m=0}{M-1} e^{j\phi_\theta[m]}x_m^* \qquad \text{and} \qquad b_m = \sumb{m=0}{M-1} e^{j\phi_\theta[m]}\sin\left(\frac{2\pi m}{M-1}\right)x_m^*
\end{align}
%
To attain unity gain in the look direction the weights must sum to one. 
where
%
\begin{align}
|\w\H\x|^2 &= \Big| \alpha a + (1-\alpha)b \Big|^2 \nn
&= \Big[\alpha a + (1-\alpha)b\Big] \Big[\alpha a^* + (1-\alpha)b^*\Big] \nn
&= \alpha^2 aa^* + \alpha a(1-\alpha)b^* + \alpha a^*(1-\alpha)b + (1-\alpha)^2bb^* \nn
&= \alpha^2 aa^* + \alpha(1-\alpha)(ab^* + a^*b) + (1-\alpha)^2bb^* \nn
&= \alpha^2 (aa^* - (ab^* + a^*b) - bb^*) + \alpha(ab^* + a^*b) + bb^* \nn
\end{align}
%
\begin{align}
\frac{\partial}{\partial\alpha} |\w\H\x|^2 
&= 2\alpha (aa^* - (ab^* + a^*b) - bb^*) + ab^* + a^*b = 0
\end{align}
%
\begin{align}
\alpha &= \frac{ab^* + a^*b}{2(aa^* - (ab^* + a^*b) - bb^*)}
\end{align}

LCA can then be defined as
%
\begin{align}
\argmin{\w}\ |z|^2 = \argmin{\w}\ z\,z^* = %\argmin{\w}\ \w\H\x = \sumb{m=0}{M-1} w_m^* x_m
\end{align}

\newpage
\section{MVDR}

By definition, the beamformer output $z[n]$ can now be expressed as the weighted sum of all the delayed data samples:
\begin{align}
z[n] = \w\H[n]\x[n] = \bmat{w_0[n]\\w_1[n]\\\vdots\\w_{M-1}[n]}^H \bmat{x_0[n]\\x_1[n]\\\vdots\\x_{M-1}[n]},\label{z}
\end{align}
where $w_m$ is the weight factor assigned to channel $m$. With static weights this would be referred to as the conventional delay-and-sum (DAS) beamformer. A large variety of weighting functions exists here for trading lateral resolution for improved noise suppression (contrast), but one always ends up with a compromise between the two~\cite{Harris1978}.

Various adaptive beamformers target this limitation by allowing the weights to change for each pixel to better fit the dynamic nature of the incoming wavefield. In other words, they attempt to use the \emph{a priori} information present in the data to improve image quality. The MVDR beamformer is one such method. It finds the set of complex weights that minimizes the beamformer's expected output power, while ensuring unity gain in the look direction~\cite{Capon1969}. This is a convex optimization problem that can be solved using Lagrange multipliers to yield the solution
%
\begin{gather}
\vec w[n] = \frac{\Ri[n]\a}{\a\T\Ri[n]\a},\label{weights}
\end{gather}
%
where $\a$ is a steering vector and $\R=E\{\x[n]\x\H[n]\}\in\mathbb{C}^{M,M}$ is the spatial covariance matrix for the full array. Since we pre-steer our data to every pixel in the image we simplify (\ref{weights}) by substituting $\a$ with a row vector $\1$ that represents broadside phase-steering. To estimate $\R$ we compute a sample covariance matrix $\eR$. In this computation we perform some degree of:
%
\begin{itemize}
\item \emph{spatial averaging} to avoid signal cancellation by decorrelating coherent echoes~\cite{Kailath1985};
\item \emph{temporal averaging} over an interval comparable to the pulse length (one to five samples) to maintain true speckle statistics~\cite{Synnevag2009a};
\item \emph{diagonal loading} to improve robustness to parameter errors~\cite{Cox1987,Maksym1979}.
\end{itemize}%

\subsection{Diagonal loading}

Assume the data to be a combination of signal and noise, $\x = \s + \n = e^{j\theta[n]}$. Then the beamformer output is
%
\begin{align}
z = \w\H\x = \w\H(\s+\n),
\end{align}
%
and the output power becomes
%
\begin{align}
|z|^2 = \w\H\x\x\H\w &= \w\H(\s+\n)(\s+\n)\H\w \nn
&= \begin{cases}
\w\H\s\s\H\w + \w\H\s\n\H\w + \w\H\n\s\H\w + \w\H\n\n\H\w &\text{when correlated}\\
\w\H\s\s\H\w + \w\H\n\n\H\w &\text{when uncorrelated}
\end{cases}
\end{align}
%
Assuming that the data is predelayed broadside, and that the window is rectangular, we may set $\a = \s$ and get
%
\begin{align}
|z|^2 = \w\H\s\s\H\w + \w\H\n\n\H\w
\end{align}


\newpage
\section{Beamforming}



\begin{align}
z[n] = \w\H[n]\x[n]
\end{align}


