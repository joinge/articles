\providecommand*\Fig{}
\renewcommand*\Fig[1]{Fig.~\ref{#1}}

\providecommand*\a{}
\renewcommand*\a{\vec a}
\providecommand*\k{}
\renewcommand*\k{\vec k}
\providecommand*\p{}
\renewcommand*\p{\vec p}
\providecommand*\R{}
\renewcommand*\R{\mat R}
\providecommand*\Ri{}
\renewcommand*\Ri{\R^{-1}}
\providecommand*\eR{}
\renewcommand*\eR{\mat{\hat R}}
\providecommand*\s{}
\renewcommand*\s{\vec s}
\providecommand*\v{}
\renewcommand*\v{\vec v}
\providecommand*\w{}
\renewcommand*\w{\vec w}
\providecommand*\x{}
\renewcommand*\x{\vec x}

\providecommand*\1{}
\renewcommand*\1{\vec 1}

\providecommand*\H{}
\renewcommand*\H{^{\scriptscriptstyle H}}
\providecommand*\T{}
\renewcommand*\T{^{\scriptscriptstyle T}}

\providecommand*\mat{}
\renewcommand\mat[1]{\boldsymbol{#1}}

\providecommand\bmat{}
\renewcommand\bmat[1]{\begin{bmatrix}#1\end{bmatrix}}

\newcommand\ux{\hat{\boldsymbol{x}}}
\newcommand\uy{\hat{\boldsymbol{y}}}
\newcommand\uz{\hat{\boldsymbol{z}}}

\chapter{Derivations}

\section{Wave Equation}

The wave equation describes how a wave moves as a function of both time and space. It forms the basis for all mathematical modeling of waves, so we will spend some time to derive it here. We will treat acoustical waves since they are most relevant to the topic in this thesis, but we could have derived it from electromagnetic waves using Maxwell's equations with some boundary conditions.

\begin{figure}[ht]
\begin{floatrow}

\floatbox{figure}[\linewidth][\FBheight][t]{%
\caption{Mass flow}}{%
\graphicsAI[drawing,width=.77\linewidth]{gfx/wave_equation_mass_flow.svg}}%

\floatbox{table}[\linewidth][\FBheight][t]{%
\caption{Symbol description}}{%
\begin{tabular}[c]{c c l}\hline
\rowcolor{tabBlue}\bf Symbol & \bf Unit & \bf Description \\\hline
$s$ & Pa = N/m$^2$ & Pressure \\
$\rho$ & kg/m$^3$ & Density \\
$S$ & Nm/K & Entropy \\
$\vec v$ & m/s & Mass velocity \\
$\dot{\boldsymbol{m}}$ & kg/s & Mass flow
\end{tabular}}

\end{floatrow}
\end{figure}


We begin by defining the net \textbf{mass flow} through a volumetric element $dV = dx\,dy\,dz$:
%
\begin{align}
\frac{\dot{\boldsymbol{m}}_\text{net}}{dV} = \ux\frac{\partial \rho\,\v}{\partial x} + \uy\frac{\partial \rho\,\v}{\partial y} + \uz\frac{\partial \rho\,\v}{\partial z} = \nabla \cdot (\rho\v).
\end{align}
%
The space and time dependence of the mass density $\rho = \rho(\p,t)$ and particle velocity $\v = \v(\p,t)$ is omitted here and in the following text for brevity. If the volume of the element is fixed a change in mass must equal a corresponding change in density. This is the law of \textbf{mass conservation}:
%
\begin{align}
\frac{\partial\rho}{\partial t} = -\nabla \cdot (\rho\v). \label{wave_eq_mass_conservation}
\end{align}
%
An additional constraint we may surely apply is the Euler's equation, a modification of Newton's second law the the total acceleration $a$ is is a function of both time and space:
%
\begin{align}
\frac{F}{dV} = \frac{m}{dV} a = \rho\Big(\frac{\partial\v}{\partial t} + \v\cdot\nabla\v\Big) = -\nabla s. \label{wave_eq_euler}
\end{align}
%
Next, an \textbf{equation of state} is needed to relate a change in density to a change in pressure. We assume our volume element to be isentropic, i.e. that the entropy is constant, or equivalently that total energy of the system is proportional to its temperature. This is true for any system that is reversible and adiabatic, i.e. that when no transfer of matter or heat occurs between the system and its surroundings. The pressure of the system then just depends on the mass density:
%
\begin{align}
s = s(\rho) \label{wave_eq_sound_pressure}
\end{align}

With this we have assumed the system to be \emph{loss-less}. In reality a passing sound wave will heat the fluid and add to the entropy, causing additional attenuation of the wave, but we will not be concerned with attenuation in this thesis.

\subsection{Linearization}

Equation (\ref{wave_eq_mass_conservation}), (\ref{wave_eq_euler}) and (\ref{wave_eq_sound_pressure}) are non-linear, but can be linearized by assuming each quantity to be a steady-state, time-independent value plus a fluctuation term:
%
\begin{align}
s = s_0 + s'  \qquad\qquad \rho = \rho_0 + \rho' \qquad\qquad \v = \v_0 + \v'
\end{align}
%
Taylor expanding (\ref{wave_eq_sound_pressure}) around zero yields:
%
\begin{align}
s(\rho) = s_0 + \frac{\partial s}{\partial\rho}(\rho-\rho_0) + \frac{1}{2}\frac{\partial^2 s}{\partial\rho^2}(\rho-\rho_0)^2 + \dots\label{wave_eq_sound_taylor_full}
\end{align}
%
Assuming a linear relationship between changes in pressure and volume the pressure perturbation term is simply:
%
\begin{align}
s' = \frac{\partial s}{\partial\rho}(\rho-\rho_0) = \frac{\partial s}{\partial\rho}\rho' = c^2\rho'. \label{wave_eq_sound_taylor_first}
\end{align}
%
When treating the Euler equation the same way we obtain:
%
\begin{align}
-\nabla (s_0 + s') &= (\rho_0 + \rho') \Big(\frac{\partial(\v_0 + \v')}{\partial t} + (\v_0 + \v')\cdot\nabla(\v_0 + \v')\Big) \nn
-\nabla s' &= (\rho_0 + \rho') \Big(\frac{\partial\v'}{\partial t} + \v'\cdot\nabla\v'\Big) \nn
\end{align}
%
When acceleration mainly depends on time, and the pressure fluctuations are relatively small,
%
\begin{align}
\frac{\partial\v'}{\partial t} >> \v'\cdot\nabla\v' \qquad\qquad\text{and}\qquad\qquad \rho_0 >> \rho',
\end{align}
%
then
%
\begin{align}
-\nabla s' &= \rho_0 \frac{\partial\v'}{\partial t}.
\end{align}
%
Finally, for the mass conservation we have:
%
\begin{align}
\frac{\partial(\rho_0 + \rho')}{\partial t} &= -\nabla \cdot \big((\rho_0 + \rho')(\v_0 + \v')\big)\nn
\frac{\partial\rho'}{\partial t} &= -\rho_0\nabla \cdot \v'. \label{wave_eq_mass_conservation2}
\end{align}
%
This assumes that the density is constant inside the volume element.

\begin{align}
\nabla\cdot(-\nabla s') &= \nabla\cdot\Big(\rho_0 \frac{\partial\v'}{\partial t}\Big) &
\frac{\partial}{\partial t}\frac{\partial\rho'}{\partial t} &= \frac{\partial}{\partial t}\Big(-\rho_0\nabla \cdot \v'\Big)\nn
-\nabla^2 s' &= \rho_0 \nabla\cdot\frac{\partial\v'}{\partial t} &
\frac{\partial^2\rho'}{\partial t^2} &= \frac{1}{c^2}\frac{\partial^2 s}{\partial t^2} = -\rho_0\nabla\cdot\frac{\partial \v'}{\partial t}
\end{align}
%
and we can now see that
%
\begin{align}
\nabla^2 s' - \frac{1}{c^2}\frac{\partial^2 s'}{\partial t^2} = 0.
\end{align}
%
This is called the homogeneous lossless wave equation, because there is no source term. When our signal $s$ signifies pressure (N/m$^2$), this links time and space by means of mass flow rate (kg/(m$^3$s).

The inhomogeneous equation can be obtained in a similar way by including a source term. If we model the source as an injection of a volume of fluid, we can include it in the linearized continuity equation:
%
\begin{align}
\frac{\partial\rho'}{\partial t} &= -\rho_0\nabla \cdot \v' - \rho_0f(\p,t). \label{wave_eq_mass_conservation_source}
\end{align}
%
where $\rho_0f(\p,t)$ is the rate of mass change (in $\left[\frac{\text{kg}}{\text{m}^3\text{s}}\right]$) caused by the mass injection. Following the exact same procedure as before we obtain:
%
\begin{align}
\nabla^2 s' - \frac{1}{c^2}\frac{\partial^2 s'}{\partial t^2} = \rho_0\frac{\partial f(\p,t)}{\partial t}.
\end{align}
%

\section{Solution}

Instead of solving the wave equation directly, we will make a qualified guess that the solution takes the form of a complex exponential in both time and space. For rectangular coordinates this can be written as:
%
\begin{align}
s(\p,t) &= A\,e^{j(\omega t - \k\cdot\p)},
\end{align}
%
Inserting this into the wave equation yields:
%
\begin{align}
\nabla^2 s = \frac{\partial^2 s}{\partial x^2} + \frac{\partial^2 s}{\partial y^2} + \frac{\partial^2 s}{\partial z^2} &= \frac{1}{c^2}\frac{\partial^2 s}{\partial t^2} \nn
(-jk_x)^2 s + (-jk_y)^2 s + (-jk_z)^2 s &= \frac{(-j\omega)^2}{c^2} s \nn
k_x^2 + k_y^2 + k_z^2 &= |\k|^2 = \frac{\omega^2}{c^2} \\
|\k| &= \frac{\omega}{c}
\end{align}
%
This means that when we can assume the spatial and temporal frequency to be related directly by the sound speed, $|\k| = \frac{\omega}{c}$, then assuming a complex exponential to be a valid solution. Another solution of the wave equation is that of a spherical wave:
%
\begin{align}
s(r,t) &= \frac{A}{r}\,e^{j(\omega t - kr)}.
\end{align}

\section{Absorption}

Our derivation of the wave equation assumed no loss of energy. In practice the wave's energy is abosorbed through viscous losses, heat conduction losses and intermolecular losses. These are strongly dependent on frequency. The wave equation can be adapted to account for absorption by assuming a complex sound speed, which will lead to a solution to the wave equation with a real exponential term. In this thesis we will not concern ourselves 

\newpage
\section{Roughness}

For a plane monochromatic wave the Rayleigh roughness parameter is quantified by:
\begin{align}
\Delta\varphi = 2k\xi\cos\theta.
\end{align}
Here $\theta$ is the incidence angle, $k = \frac{2\pi}{\lambda}$ is the wavenumber of the incoming wave, $\xi$ is the distance from the scattering point to the mean surface plane, and $\Delta\varphi$ is the phase difference.

\begin{figure}[th]
\graphicsAI[drawing,width=\linewidth]{gfx/roughness.svg}
\end{figure}

To see how roughness affects the specular reflection we compute the mean reflected wave as
\begin{align}
<p> &= V\int\limits_{-\infty}^{\infty} e^{-j\Delta\varphi(\xi)} p(\xi) d\xi,
\end{align}
where $p(\xi)$ is the probability density function of $\xi$. If we assume normal distribution, we get:
\begin{align}
<p> &= V\int\limits_{-\infty}^{\infty} e^{-j2k\xi\cos\theta} \frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{\xi^2}{2\sigma^2}} d\xi \nn
&= \frac{V}{\sqrt{2\pi}\sigma} \int\limits_{-\infty}^{\infty} e^{-\frac{\xi^2}{2\sigma^2}-j2k\xi\cos\theta} d\xi &\Big|{\begin{matrix}\scriptscriptstyle\hspace{-0.64cm} a = \frac{1}{2\sigma^2}\\
\scriptscriptstyle b = -j2k\cos\theta\end{matrix}}\nn
&= A \int\limits_{-\infty}^{\infty} e^{-a\xi^2 + b\xi} d\xi \nn
&= A \int\limits_{-\infty}^{\infty} e^{-a(\xi - \frac{b}{2a})^2 - \frac{b^2}{4a}} d\xi \nn
&= A e^{\frac{-b^2}{4a}} \int\limits_{-\infty}^{\infty} e^{-a(\xi - \frac{b}{2a})^2} d\xi & \Big|_{y = \xi - \frac{b}{2a}}\nn
&= A e^{\frac{-b^2}{4a}} \int\limits_{-\infty}^{\infty} e^{-ay^2} dy & \Big|_{z = \sqrt{a} y}\nn
&= A e^{\frac{-b^2}{4a}}\frac{1}{\sqrt{a}} \int\limits_{-\infty}^{\infty} e^{-z^2} dz \nn
&= A e^{\frac{-b^2}{4a}}\sqrt{\frac{\pi}{a}} \nn
&= \frac{V}{\sqrt{2\pi}\sigma} \sqrt{\frac{\pi}{\frac{1}{2\sigma^2}}} e^{\frac{-(-j2k\cos\theta)^2}{4\frac{1}{2\sigma^2}}} \nn
&= V e^{-2k^2\sigma^2\cos^2\theta}
\end{align}
This reflection coefficient is valid when the Rayleigh parameter is small (i.e. small frequency and relief amplitude), and at grazing incidence. Conventional limit of validity is $\frac{\pi}{2}$, which corresponds to $\sigma = \frac{\lambda}{8\cos\theta}$ and a coherent loss of 10.7dB.



\section{LCA}

Let $\X[n]$ be the data received by an array, pre-steered to all pixels in the image, and $\w$ be the window applied to these spatial data. Then we defined the beamformer output $z$ as the weighted sum of the data:
%
\begin{align}
z[\w,n] = \w\H\X[n] = \sumb{m=0}{M-1} w_m x_m^*[n]
\end{align}
%
From a set of $P$ windows the LCA beamformer selects the window $p$ that yield the least output power:
%
\begin{align}
\argmin{p}{E\big\{|z|^2\big\}} = \argmin{p}{E\big\{|\w_p\H\X[n]|^2\big\}} \qquad\text{subject to}\qquad \w\H\a = 1
\end{align}
%
We can estimate $E\big\{|\w_p\H\X[n]|^2\big\}$ as
%
\begin{align*}
\sigma^2_{z_p}[n] = \frac{1}{N_k} \sumb{n'=n-K}{n+K} | z_p[n'] |^2
\end{align*}
%
To add some extra flexibility, we can also estimate the variance by a weighted combination of local pixels
%
\begin{align*}
\sigma^2_{z_p}[x,n] = \frac{1}{N_x N_k} \sumb{x'=x-X}{x+X} \sumb{n=n-K}{n+K} w_\text{prf}[x',n']\big| z_p[x',n'] \big|^2
\end{align*}
%
where $w_\text{prf}[x',n']$ is a normalized 2 dimensional weight function. 

Kaiser:
%
\begin{align*}
w[n] = \frac{I_0\big( \pi\alpha\sqrt{1-(\frac{2n}{N-1}-1)^2}\big)}{I_0(\pi\alpha)}
\end{align*}
%
where $I_0$ is a zeroth order modified Bessel function of the first kind.

\subsection{Oversampling and steering}

Steering wildly is not a good idea.

Too much steering, beamformer becomes too agressive. Uncertainty in source amplitude grows.

\begin{itemize}
\item More steering -> more aggressive suppression of interference at the cost of boosted sidelobes / noise.
\item More steering -> Larger variations in amplitude of sources
\end{itemize}

Idea to steer within a fraction of the rectangular window's mainlobe. 

\begin{align*}
d = \frac{\pi\,\theta_\text{open}\,\lambda}{M\,d\,O_s}
\end{align*}


HISAS1030:
\begin{itemize}
\item 25$^\circ$ opening angle.
\item M$=32$ elements.
\item 
\end{itemize}

- Retain source amplitude
- Retain speckle statistics
- Improve resolution
- Easy to use



Skifte til 1/4 av bredden 



Tommelfingerregel for styring
- 1/2 av rektangulær for punkter
- 1/2 Hamming/Kaiser for skarpe transisjoner

- Omtrent samme beta i transisjoner
- Samme beta i spekkel/highlight
- Annen beta i skygge


Bildeparametre:
- Oppløsning
- Kontrast.
- Dynamisk område.
- I sonar er spekkel tekstur! Vi kan tillate en undertrykking av den, men ønsker forholdsvis lik spekkelstatistikk.
- Temporal and spatial shift variance. Et punkt burde avbildes med omtrent samme amplitude uansett hvor det er i bildet.
- Sensitivitet
- Steered response.
- Coherence
- Qualitative assessment

Hvor mange trenger vi.
1. Brute force. Tester alle kombinasjoner av
   - Oversampling
   - Beta
   - Styring
2. Hva det koker ned til.
   - Oversampling. Virker som om 2*M er en god regel, trenger litt mer om vi tillater mye styring.
   - Beta. Holder med 3-6. Kan regnes anaAnalytisk
   - Styring. Desto mer styring, desto mer agressiv beamforming. Burde ikke styre mer enn av vi får litt variasjon av nullpunkt, men med liten skift-invarians i amplitide.



Sammenlignet med MVDR
- Hvorfor trenger vi ikke subarray / tidsmidling?
- MVDR er ``for'' adaptiv. Selv med 1-gain rett frem kan signalet derfra kansellers. Subarray midling hjelper mot dette, men tar ned oppløsningen. LCA har ikke frihet til å velge amplitude/phase kombinasjoner som tillater signalkansellering, og det viser seg at vi da ikke trenger å midle for å oppnå ønsket resultat.

%  coarse delay adjustment is usually achieved by applying delays to the sensor channels to negate the difference in travel time from the point of interest, and cause the  thereby aligning the phase of the signals coming from that source. Next a set of weights, or window, is applied to the sensors to Finally a set of weights  , which in effect achieve this by applying delays and weigths to the sensor channels to coherently combine signals from the direction of interest.
% 




\subsection{Tricks}

Now let us choose a trigonometric window function:
%
\begin{align}
\w = e^{j\phi_\theta[m]}\big(\alpha - (1-\alpha)\cos\left(\frac{2\pi m}{M-1}\right)\big)
\end{align}
%
where $\phi_\theta[m] = \frac{2\pi}{\lambda}dm\sin\theta$. Inserting this yields:
%
\begin{align}
\w\H\x &= \sumb{m=0}{M-1} e^{j\phi_\theta[m]}\Big(\alpha - (1-\alpha)\cos\left(\frac{2\pi m}{M-1}\right)\Big) x_m^* \nn
&= \alpha\sumb{m=0}{M-1} e^{j\phi_\theta[m]} x_m^* - (1-\alpha)\sumb{m=0}{M-1} e^{j\varphi[m]}\cos\left(\frac{2\pi m}{M-1}\right) x_m^* \\
&= \alpha \a\T\x + (1-\alpha)\b\T\x
\end{align}
%
where:
%
\begin{align}
\a = \begin{bmatrix}
     1 \\
     e^{j\frac{2\pi}{\lambda}d\sin\theta} \\
     e^{j\frac{2\pi}{\lambda}2d\sin\theta} \\
     \vdots \\
     e^{j\frac{2\pi}{\lambda}d(M-1)\sin\theta}
     \end{bmatrix} \qquad \text{and} \qquad
\b = \begin{bmatrix}
     0 \\
     e^{j\frac{2\pi}{\lambda}d\sin\theta}\sin\left(\frac{2\pi m}{M-1}\right) \\
     e^{j\frac{2\pi}{\lambda}2d\sin\theta}\sin\left(\frac{2\pi m}{M-1}\right) \\
     \vdots \\
     0
     \end{bmatrix}
\end{align}
%
To attain unity gain in the look direction the weights must sum to one. 
%
\begin{align}
\w\T\1 &= \big(\alpha\a - (1-\alpha)\b\big)\T\1 = 1
\end{align}
%
This is true for any value of $\alpha$ if $\a\T\1 = 1$ and $\b\T\1 = 1$. 

where
%
\begin{align}
|\w\H\x|^2 &= \Big| \alpha a + (1-\alpha)b \Big|^2 \nn
&= \Big[\alpha a + (1-\alpha)b\Big] \Big[\alpha a^* + (1-\alpha)b^*\Big] \nn
&= \alpha^2 aa^* + \alpha a(1-\alpha)b^* + \alpha a^*(1-\alpha)b + (1-\alpha)^2bb^* \nn
&= \alpha^2 aa^* + \alpha(1-\alpha)(ab^* + a^*b) + (1-\alpha)^2bb^* \nn
&= \alpha^2 (aa^* - (ab^* + a^*b) - bb^*) + \alpha(ab^* + a^*b) + bb^* \nn
\end{align}
%
\begin{align}
\frac{\partial}{\partial\alpha} |\w\H\x|^2 
&= 2\alpha (aa^* - (ab^* + a^*b) - bb^*) + ab^* + a^*b = 0
\end{align}
%
\begin{align}
\alpha &= \frac{ab^* + a^*b}{2(aa^* - (ab^* + a^*b) - bb^*)}
\end{align}

LCA can then be defined as
%
\begin{align}
\argmin{\w}\ |z|^2 = \argmin{\w}\ z\,z^* = %\argmin{\w}\ \w\H\x = \sumb{m=0}{M-1} w_m^* x_m
\end{align}

\newpage

\section{MVDR}

By definition, the beamformer output $z[n]$ can now be expressed as the weighted sum of all the delayed data samples:
\begin{align}
\argmin{\w}{E\big\{||\w\H\x||^2\big\}} \qquad\text{subject to }\w\H\a = c
\end{align}
%
\begin{align}
E\big\{||\w\H\x||^2\big\}
&= E\big\{\big(\w\H\x\big)\big(\w\H\x\big)^*\big\} \nn
&= \w\H E\big\{\x\x\H\big\}\w \nn
&= \w\H\R\w
\end{align}
%
When solving these convex optimization problems we can make use Lagrange multipliers.
%
\begin{align}
\frac{\partial}{\partial\w} \Big( \w\H\R\w + \lambda(\w\H\a - c)\big) = \R\w + \lambda\a = 0
\end{align}
%
Solving for $\w$ gives
%
\begin{align}
\w = -\lambda\Ri\a 
\end{align}
%
Substituting this into the constraint equation gives
%
\begin{align}
(-\lambda\Ri\a)\H\a = -\lambda\a\H\Ri\a = c
\end{align}
%
\begin{align}
\lambda = -\frac{c}{\a\H\Ri\a}
\end{align}
%
Finally, insering this into the weight equation we have
%
\begin{align}
\w = c\frac{\Ri\a}{\a\H\Ri\a}
\end{align}
%
With $c=1$ we have the minimum variance distortionless response (MVDR) beamformer. 


\subsection{Diagonal loading}

Assume the data to be a combination of signal and noise, $\x = \s + \n = e^{j\theta[n]}$. Then the beamformer output is
%
\begin{align}
z = \w\H\x = \w\H(\s+\n),
\end{align}
%
and the output power becomes
%
\begin{align}
|z|^2 = \w\H\x\x\H\w &= \w\H(\s+\n)(\s+\n)\H\w \nn
&= \begin{cases}
\w\H\s\s\H\w + \w\H\s\n\H\w + \w\H\n\s\H\w + \w\H\n\n\H\w &\text{when correlated}\\
\w\H\s\s\H\w + \w\H\n\n\H\w &\text{when uncorrelated}
\end{cases}
\end{align}
%
Assuming that the data is predelayed broadside, and that the window is rectangular, we may set $\a = \s$ and get
%
\begin{align}
|z|^2 = \w\H\s\s\H\w + \w\H\n\n\H\w
\end{align}


\newpage
\section{Beamforming}



\begin{align}
z[n] = \w\H[n]\x[n]
\end{align}




\subsection{Element}

The frequency response of an element is is given by the Fourier transform of the element's window function.
%
\begin{align}
W(\k) = \int\limits_{V} w(\p)\,e^{-j\k\dot\p} dV
\end{align}
%
where $\p = \bmat{x & y & z}\T$ and $dV = dx\,dy\,dz$. For a rectangular 2D element spanning the xy-plane, having sides with length $d_x$ and $d_y$, the frequency response becomes:
%
\begin{align}
W_\text{rect}(k_x, k_y) = \frac{\sin\frac{k_x\,d_x}{2}}{\frac{k_x\,d_x}{2}}\,\frac{\sin\frac{k_y\,d_y}{2}}{\frac{k_y\,d_y}{2}} = \sinc\frac{k_x\,d_x}{2}\,\sinc\frac{k_y\,d_y}{2}
\end{align}

\subsubsection{Opening angle and element size}

What is the element size of the HISAS1030 sonar? This can be inferred from the element frequency response:
%
\begin{align}
W_\text{rect}(k_x) = \frac{\sin\frac{k_x\,d_x}{2}}{\frac{k_x\,d_x}{2}} = \frac{1}{\sqrt{2}}
\end{align}
%
This can be solved for $\frac{k_x\,d_x}{2}$ either by series expansion of $\sin(\cdot)$, or numerically to find that $\frac{k_x\,d_x}{2} \approx 1.39$. For HISAS1030, with an opening angle of 25$^\circ$ at 100kHz in both directions, this means the element size must be quadratic with sides:
%
\begin{align}
d = \frac{2*1.39}{k_x} = \frac{2*1.39}{2\pi \frac{f_c}{c}\sin\theta} = \frac{1.39*1500\text{ms}^{-1}}{\pi\, 100\text{kHz}\,\sin{12.5^\circ}} = 3.07\text{cm}
\end{align}
%
This leaves a little space between each sensor since the element spacing is around 3.75cm.

\newpage
\section{Window Parameters}

Signal model, monochromatic place wave from broadside with gaussian noise:
\begin{align}
x_m[n] = s_m[n] + q[n] = Ae^{j\Omega_0mn} + q[n]
\end{align}

Beamformer output
\begin{align}
z[n] = \sumb{n}{} w^*[n]\;x[n]
\end{align}

Frequency response of the window

\begin{align}
W(k_x) = \sumb{m}{} w_m\;e^{jk_x \p_x} =
\begin{cases}
\frac{\sin\left(\frac{M}{2}k_x d\right)}{\sin\left(\frac{1}{2}k_x d\right)} & \text{rectangular}                                         
\end{cases}
\end{align}

Applying a window reduces the signal power because it gets attenuated at both ends. We quantify this effect with the coherent power gain:

\begin{align}
W(\k) &= \sumb{m}{} w_m\;e^{j\k\cdot\p_m}
\end{align}

\begin{align}
Z(\k) &= \sumb{m}{} w_m\;(s_m+q_m)\;e^{-j\k\cdot\p_m} \nn
&= \sumb{m}{} w_m\;A\;e^{j\k\cdot\p_m}\;e^{-j\k\cdot\p_m} + \sumb{m}{} w_m\;q_m\;e^{j\k\cdot\p_m} \nn
&= A \underbrace{\sumb{m}{} w_m}_\text{signal gain} + \sumb{m}{} w_m\;q_m\;e^{j\k\cdot\p_m}
\end{align}


\begin{align}
\text{Coherent Gain} &= W(0) = \sumb{m}{}w_m
\end{align}

\begin{align}
\text{Coherent Power Gain} &= \big|W(0)\big|^2 = \big|\sumb{m}{}w_m \big|^2
\end{align}

\begin{align}
\text{Incoherent Power Gain} &= \sumb{m}{}w_m^2
\end{align}

\begin{align}
\text{Equivalent Noise Bandwidth} &= \frac{\text{Noise Power}}{\text{Coherent Power Gain}} = \frac{\frac{N_0}{{\color{red}d}}\sumb{m}{}w_m^2}{\big|\sumb{m}{}w_m\big|^2}
\end{align}

\begin{align}
\text{Processing Gain} &= \frac{S_o/N_o}{S_i/N_i} = \frac{A^2\big|\sumb{m}{}w_m\big|^2 \big/ \sigma_q^2\sumb{m}{}w_m^2}{A^2 / \sigma_q^2} = \frac{\big|\sumb{m}{}w_m\big|^2}{\sumb{m}{}w_m^2}
\end{align}

\begin{align}
\text{Processing Loss} &= \frac{\text{Coherent Power Gain}}{\text{Equivalent Noise Bandwidth}} = \frac{\big|\sumb{m}{}w_m \big|^2}{\big|\sumb{m}{}w_m \big|^2}
\end{align}

\begin{align}
\text{Scallopping loss} &= \frac{\left|W\left(\frac{\pi}{2{\color{red}O}Md}\right)\right|}{W(0)} = \frac{\left|\sumb{m}{}w_m\;e^{-j\k\cdot\p_m}\right|}{\sumb{m}{}w_m}
\end{align}

\begin{align}
\text{Scallopping loss} &= \text{Prosessing Loss}_\text{dB} + \text{Scallopping Loss}_\text{dB} 
= 
\end{align}
Worst Case Processing Loss = Prosessing Loss + Scallopping Loss

=> a measure of the worst case reduction in SNR which results from the combination of the window function and the worst case frequency location.


Narrow ones:
- Best coherent gain, lowest equivalent noise bandwidth, and most sensitive to steering meaning not needing to steer as much for some effect.


Beamforming:
- Maximize resolution
- Minimize noise/error, both coherent and incoherent
- Minimize signal cancellation

Gauss: Miminized time-bandwidth product
  - 
  
Rectangular
  - 
Dolph-Cheb: Minimize mainlobe width given sidelobe suppression
Kaiser: For a restricted energy and time duration, maximize energy in the band of frequencies W.

Adaptive windows perform best in detection of closely separated angles of significantly amplitudes.


\section{Mathematical Proofs}

\subsection[Proof d/dw\^{}H w\^{}HRw = 2Rw]{Proof: $\frac{\partial}{\partial\w\H} \w\H\R\w = 2\R\w$}

To prove this relation we will write the matrix operations out on index form, and 
%
\begin{align}
\w\H\R\w &= \sumb{i=1}{N}w_i^* \sumb{j=1}{N}  R_{ij} w_j \nn
&= \sumb{\substack{i=1\\i\ne k}}{N} w_i^* \sumb{j=1}{N} R_{ij} w_j + w_k^*\sumb{j=1}{N} R_{kj} w_j \nn
&= \sumb{\substack{i=1\\i\ne k}}{N} w_i^* \sumb{\substack{j=1\\j\ne k}}{N} R_{ij} w_j + w_k^*\sumb{j=1}{N} R_{kj} w_j + w_k\sumb{i=1}{N}w_i^* R_{ik} \nn
&= \sumb{\substack{i=1\\i\ne k}}{N} w_i^* \sumb{\substack{j=1\\j\ne k}}{N} R_{ij} w_j + w_k^*\sumb{j=1}{N} R_{kj} w_j + w_k^*\sumb{i=1}{N}w_i R_{ik}^* \nn
&\overset{R_{ij}=R_{ji}^*}{=} \sumb{\substack{i=1\\i\ne k}}{N} w_i^* \sumb{\substack{j=1\\j\ne k}}{N} R_{ij} w_j + 2w_k^*\sumb{i=1}{N} R_{ki} w_i
\end{align}
%
Partial differentiation with respect to $w_k^*$ then gives:
%
\begin{align}
\frac{\partial}{\partial w_k^*}\;\w\H\R\w
&= 2\sumb{i=1}{N} R_{kj} w_i
\end{align}
%
Hence, when we apply the partial differentiation as a row operation we get:
%
\begin{align}
\frac{\partial}{\partial \w^H}\;\w\H\R\w
&= \bmat{
\frac{\partial}{\partial w_1^*}\;\w\H\R\w \\
\frac{\partial}{\partial w_2^*}\;\w\H\R\w \\ \vdots \\
\frac{\partial}{\partial w_M^*}\;\w\H\R\w}
= \bmat{
2\sum_{i=1}^{N} R_{1j} w_j\\
2\sum_{i=1}^{N} R_{2j} w_j\\ \vdots \\
2\sum_{i=1}^{N} R_{Nj} w_j}
= 2\R\w
\end{align}