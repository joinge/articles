\section{Motivation}
The rapid development of computer game technology and accompanying programming languages, as shown in Chapter \ref{chap1}, have recently provided researchers with small personal supercomputers, comprised in a single graphics processing unit (\nom{GPU}{Graphics processing unit}). %The latest graphics cards\footnote{As of January 2014.} from both \nom{Nvidia}{Graphics card vendor} and \nom{AMD}{Graphics card vendor} provide more than 5 T\nom{FLOPS}{Floating point operations per second} single precision and 1.5 TFLOPS double precision computations. For double precision, this is more than the world's most powerful supercomputer could provide in 1998, and that was a room full of computers.
This immense rise in computational capabilities and improved programmability are currently changing how ultrasound imaging systems are designed. Algorithms that previously had to be implemented in hardware, for performance reasons, can now be implemented in software. 
%Algorithms, either too complicated or costly to implement in hardware, and where a software implementation was thought to be too computationally heavy for real-time use, become realizable. 
It is clear that high-performance programmable processors, like the GPU, already have and will continue to make future ultrasound imaging systems more flexible, cheaper to produce, and equipped with even more cutting-edge processing.

The Capon beamformer in ultrasound imaging is a good example of an algorithm that has been widely studied over the last decade where the number of calculations was thought to be too high for real-time processing to happen in near future. As shown in Section \ref{sec:adaptbf}, an effective processing rate of hundreds of GFLOPS is required to achieve real-time processing for cardiac ultrasound imaging. This number, as explained in Section \ref{sec:adaptbf}, also grows with larger subarrays and an increasing number of samples per second. Nevertheless, with modern GPUs, this amount of processing is finally available within a single GPU card. When researchers are exploring new algorithms for ultrasound imaging, it is important to keep the architecture of parallel accelerators in mind. If a new complex algorithm is supposed to run in real time, it needs to fit the programmable and parallel pipeline of modern ultrasound scanners.

\section{Aims of study}
The overall aim of this study has been to investigate the possibility of utilizing GPUs for advanced processing in an ultrasound imaging system. 

The main focus has been the Capon beamformer, and the problem of making this computationally intense algorithm available for real-time ultrasound imaging [\textbf{Papers\,I} and \textbf{II}]. However, two additional methods have also been explored. The first one being adaptive visualization of cardiac ultrasound volumes [\textbf{Paper\,IV}], and the second one being the simulation of dense ultrasound pressure fields [\textbf{Paper\,V}]. Both share the property of being computationally complex, but on the other hand they consist of many independent computations, which makes them perfectly suited for parallel GPU acceleration.

Well into the project, when a real-time Capon beamformer was realized, and loops of images for the first time were processed at real-time frame rates, new issues where discovered and had to be solved. This led to a more theoretical study of the Capon beamformer in \textbf{Paper\,III}, with special attention on how to obtain high lateral resolution while preserving the important shift-invariant property of ultrasound imaging. Shift-invariant behavior is crucial if the method is ever to be applied for live scanning. 

%\subsubsection{Accelerate the Capon beamformer to facilitate real time imaging}

%\subsubsection{}

\section{Summary of papers}

\subsection{Paper\,I}
\textbf{An Optimized GPU Implementation of the MVDR Beamformer for Active Sonar Imaging}\\
J.\:I.\:Buskenes, \textbf{J.\:P.\:\AA{}sen}, C.-I.\:C.\:Nilsen and A.\:Austeng\\
{\it IEEE Transactions on Oceanic Engineering, accepted for publication.}\\\\
The first paper describes in detail how the Capon beamformer is mapped to the GPU architecture. Even though the paper is written within the field of active \nom{sonar}{SOund Navigation And Ranging (usually under water)} imaging, the presented implementation is applicable to a range of active imaging systems. A similar discussion for cardiac ultrasound imaging can be found in \textbf{Paper\,VI}.  Active sonar imaging typically differs from medical ultrasound imaging by a less strict real-time requirement and fewer array elements. This makes it somewhat easier to reach the goal of real-time processing. The transmit beams used for sonar imaging are also much wider than the once used for ultrasound imaging. This makes techniques like the BS-Capon beamformer less attractive for sonar imaging. However, as shown in this paper, low-complexity methods are not needed to reach real time Capon beamforming for sonar imaging.

The estimation of the spatial covariance matrix receives special attention in this study. In previous literature on Capon beamforming the matrix inversion has always been regarded as the most computationally complex step. In this paper we show that estimation of the sample covariance matrix is the most complex part when spatial and temporal smoothing is performed with common parameters. We then show how the computational complexity of this estimation procedure can be reduced from cubic to square. Finally, an in-depth analysis of the arithmetic throughput on multiple platforms is given. Despite our efforts, the number of effective FLOPS is only 4 \% and 14 \% of the theoretical throughput of the target GPU for the matrix equation solver and covariance matrix estimator respectively. Still, the reported throughput of 1 Mpx/s on a high-end GPU is enough to provide real-time processing for sonar imaging.

\subsection{Paper\,II}
\textbf{Implementing Capon Beamforming on a GPU for Real-Time Cardiac Ultrasound Imaging}\\
\textbf{J.\:P.\:\AA{}sen}, J.\:I.\:Buskenes, C.-I.\:C\:Nilsen, A.\:Austeng and S.\:Holm\\
{\it IEEE Transactions on Ultrasonics, Ferroelectrics, and Frequency Control, vol. 61, no. 1, pp. 76-85, Jan. 2014.}\\\\
The second paper aims at implementing real-time Capon beamforming for cardiac ultrasound imaging. Achieving this will facilitate further study of the method's \textit{in vivo} performance in the future. This is something that has been suggested as further work in many publications on Capon beamforming for medical ultrasound imaging over the past decade. In \textbf{Paper\,I}, arrays with no more than 32 elements were investigated. A linear array for cardiac ultrasound imaging typically has 64 or more elements. In \textbf{Paper\,VI}, which is summarized in \textbf{Paper\,II}, it is shown that our implementation from  \textbf{Paper\,I} does not reach the level of throughput required for real-time Capon beamforming in cardiac ultrasound imaging. The matrices that have to be inverted become to large, and the frames that need to be processed per second are too many.

In this paper, we implement the beamspace version of the Capon beamformer (\nom{BS-Capon}{Beamspace capon beamforming}) on the GPU  to reduce the covariance matrix size. For parameters that give similar performance for BS-Capon and element-space Capon (\nom{ES-Capon}{Element space capon beamforming}), we show that real-time BS-Capon beamforming is feasible for cardiac ultrasound imaging. The reported processing throughput is able to keep up with the acquisition frame rate in a typical cardiac ultrasound imaging system equipped with 64- and 96-element linear arrays.  \textbf{Papers\,II} and \textbf{VI} also present, for the first time, videos where the ES-Capon and BS-Capon beamformer have been applied on loops of simulated and \textit{in vivo} medical ultrasound images.

\subsection{Paper\,III}
\textbf{Capon Beamforming and Moving Objects - An Analysis of Lateral Shift-Invariance}\\
\textbf{J.\:P.\:\AA{}sen}, A.\:Austeng and S.\:Holm\\
{\it IEEE Transactions on Ultrasonics, Ferroelectrics, and Frequency Control, accepted for publication.}\\\\
In the third paper we study the shift-invariant property of an imaging system based on the Capon beamformer. As mentioned, shift-invariant imaging is essential if the method is ever to be used in practice. The paper is based on an observation of aliasing artifacts when the Capon beamformer was used to image bright point scatterers \textit{in vitro} and in simulations. The intensity of the point scatterers were observed to oscillate as either they or the probe moved. In earlier work on Capon beamforming for medical ultrasound imaging the real-time nature of ultrasound imaging has often been ignored, and a large degree of oversampling on transmit might have been applied without this being clearly stated. Oversampling on transmit will reduce the acquisition frame rate, and is therefore not an option if the imaging system is used to image rapidly varying objects. Smooth presentation of probe motion is equally important since real-time user interaction is one of the key selling points of ultrasound imaging.

Further, it has been investigated how the Capon beamforming achieves its super-resolution, and how this makes it highly sensitive to differences between the assumed steering vector and the signal propagation vector. Earlier work, focusing on single images, has typically referred to this effect as speed-of-sound errors, however, it also comes naturally into play when objects move across an imaging sector which has insufficient lateral sampling. With a narrowband and farfield model it is shown that the Capon beamformer suffers from lateral gain variations as large as 27 dB for parameters previously used to obtain high resolution medical ultrasound images.  To obtain the same lateral gain variations as for \nom{DAS}{Delay-and-sum beamforming} beamforming, 25 times oversampling is shown to be required. The same gain variations are observed for broadband nearfield simulations. Finally, we show that the gain variation can be reduced by oversampling on receive using phase rotation steering, hence improving shift-invariance. This is achieved without affecting the acquisition frame rate and with only a minor increase in computational complexity. The method is successfully applied on simulations and \textit{in vitro} phantom data.

\subsection{Paper\,IV}
\textbf{Adaptive Volume Rendering of Cardiac 3D Ultrasound Images - Utilizing Blood Pool Statistics}\\
\textbf{J.\:P.\:\AA{}sen}, E.\:Steen, G.\:Kiss, A.\:Thorstensen and S.\:I.\:Rabben\\
{\it Proc. SPIE Medical Imaging 2012, vol. 8320, pp. 832008.}\\\\
The fourth paper proposes an adaptive volume rendering method based on statistics derived from the blood pool of the left ventricle. Noise located in the blood pool tends to occlude cardiac tissue when rendered in 3D, and is often impossible to remove by adjusting global rendering parameters. This is because ultrasound signals have high variability within blood, as well as high variability within tissue, even when heavily smoothed. Delineation of the blood pool is done by a state estimation algorithm, capable of tracking the endocardium in real time. The final visualizations are compared, with respect to location of tissue, by using a state-of-the-art endocardium segmentation tool. The paper presents both quantitative and qualitative results supporting the method's improved capabilities of reducing tissue dropouts and spurious structures inside the blood pool, leading to a maximized amount of visible endocardium tissue. The proposed method is implemented on a GPU with real-time frame rates as the result. This results shows that with modern GPUs it is possible to add more advanced visualization methods to an ultrasound imaging system and still have real-time performance.

\subsection{Paper\,V}
\textbf{Huygens on Speed: Interactive Simulation of Ultrasound Pressure Fields}\\
\textbf{J.\:P.\:\AA{}sen} and S.\:Holm\\
{\it Proc. IEEE Ultrasonics Symposium 2012, pp. 1643-1646.}\\\\
The fifth paper presents an interactive simulation tool capable of simulating dense pressure fields from ultrasound arrays in real time. Simulation tools are heavily used by researchers to test new algorithms and the performance of new array designs prior to manufacturing. However, dense simulations involve extensive calculations and computational time. With the presented simulator we aim at reducing the time needed for calculating pressure fields by means of GPU acceleration. The tool is based on Huygens' principle, which describes diffraction caused by a slit as the superposition of several point sources located inside the opening. Thus, the simulator works by accumulating the contribution from a collection of point sources in a set of observation points. How the source and observation points are laid out is left for the user to decide. Point sources positioned along a line will for instance simulate an ultrasound array. The simulator is linked with both a painting interface for interactive drawing of arrays, and a Matlab interface for precise scripting of array configurations. The main contribution in this paper is the increased performance of the GPU implementation compared with CPU and Matlab\footnote{The Ultrasim toolbox.} versions. Second, the painting interface provides a neat way of demonstrating array beamforming principles in real time. We believe this to be of great value both for array designers and when teaching array processing.

\section{Main contributions}
The main contributions of this thesis are:
\begin{enumerate}
\item a GPU implementation of the Capon beamformer.
\item a GPU implementation of the beamspace Capon beamformer.
\item achieving real-time beamspace Capon beamforming for cardiac ultrasound imaging.
\item a first-time investigation of Capon beamforming applied on multiple frames in medical ultrasound imaging (simulated, \textit{in vitro}, and \textit{in vivo}).
\item an analysis of shift-invariance of the Capon beamformer when applied to medical ultrasound imaging.
\item a method for real-time reduction of blood-pool noise in volume renderings of cardiac ultrasound volumes.
\item a GPU implementation of a painting tool for rapid simulation and visualization of ultrasound pressure fields.
\end{enumerate}
In addition, the thesis provides several more general discussions on how to utilize the GPU to accelerate advanced ultrasound imaging algorithms. 

\section{Discussion and future work}
\subsection{Paper\,I}
As mentioned, we were only able to achieve a fraction of the peak theoretic throughput of the target GPU in \textbf{Paper\,I}. This shows how hard it is to reach the theoretical level of throughput, and that how close one can get is highly algorithm dependent. There might be ways to improve on these numbers, but both the matrix equation solver and the covariance matrix estimation step consist of several points where fine granular synchronization and serialized instructions are needed. These facts will restrict even the most finely tuned implementation from reaching the maximum throughput of the GPU. The work in \textbf{Paper I} also showed that the covariance estimation kernel was memory bound, hence there are not enough instructions to hide all the memory latency. Further improvements through improved memory management could therefore be possible. 

An interesting observation in \textbf{Paper\,I} can be found in Fig.\,\ref{code_assess_flops}. Here we see how the achieved throughput of the covariance estimation kernel is more than three times higher than the theoretical throughput of a high-end \nom{CPU}{Central processing unit} (The target CPU is from 2010). Note that the target high-end GPU, the Nvidia Quadro 6000, is also from 2010. This clearly shows the benefit of modern GPU computing.

The matrix equation found in the Capon beamformer is solved using a batched Gauss Jordan solver implemented by Nvidia. In our work we focused on the covariance matrix estimation step. Nevertheless, \textbf{Paper\,I} showed that the solver had significantly lower throughput than the covariance matrix estimation kernel. A natural next step would therefore be to analyze the current solver, and figure out if any further optimization is possible. Since the sample covariance matrix is hermitian, a solver based on Cholesky decomposition should also help to improve the throughput. However, a triangular matrix can make memory management and finding the best thread layout even more difficult. 

\subsection{Paper\,II}
In \textbf{Paper\,II} we focused on achieving real time Capon beamforming for cardiac ultrasound imaging by implementing the BS-Capon beamformer on a GPU. However, we also present the first medical ultrasound loops processed with ES- and BS-Capon beamforming.  The paper does not provide any detailed evaluation of the method's \textit{in vivo} performance. Yet, initially it has been proven hard to transfer all results obtained in simulations to \textit{in vivo} images. Improvements are observed, but they are not large enough to justify the large number of calculations involved with Capon Beamforming. The beamformers are clearly able to decrease the lateral width of point scatterers and thin structures \textit{in vivo}, and to sharpen edges. On the other hand, the observed contrast is not improved, and sometimes it is even worse (Fig.\,6b of \textbf{Paper\,II}). Since the Capon beamformer only affects directional noise, it is clear that contrast will get worse in low \nom{SNR}{Signal-to-noise ratio} situations when signal cancellation occurs. The oversampling approach presented in \textbf{Paper\,III} might improve on this, but it will only reduce signal cancellation if the phase shifts across the aperture are close to linear and small. Another issue is that bright points with a wide lateral profile exhibit better visual contrast when surrounded by speckle noise than points with narrow lateral profiles. Future work should address a detailed investigation of why some results, especially the contrast obtained in simulations, are so hard to achieve \textit{in vivo}. It will also be crucial to show larger improvements \textit{in vivo} than what is presented in \textbf{Paper\,II}, both to justify all our computations, and to show an image with both highly improved resolution and contrast. 

As pointed out at the end of \textbf{Paper\,II}, cardiac ultrasound imaging might not be the best modality for Capon beamforming. Cardiac ultrasound imaging was mainly selected because it is the medical ultrasound modality that requires the most calculations per second. A better suited adaptive beamformer for cardiac ultrasound imaging might be the low-complexity adaptive beamformer (\nom{LCA}{Low complexity adaptive (beamformer)} beamformer), where the Capon optimization problem is applied on a set of predefined windows. This method has linear computational complexity and has similar super-resolution properties as the Capon beamformer. If only minor improvements are obtained, it would be easier to ignore this fact if the algorithm is less computationally costly. %Finally, it would also be interesting to see how the Eigenspace-based Capon beamformer performs on cardiac images, and how its absence of a distortionless criterion will influence the image spatially and temporally. 

The work in \textbf{Paper\,II} made it clear that interesting findings are done when a real-time implementation makes it possible to watch the temporal behavior of an algorithm. An observation of temporal artifacts was the fact that stimulated for the work of \textbf{Paper\,III}. 

\subsection{Paper\,III}
In \textbf{Paper\,III} we investigate the inherent self nulling of Capon beamforming, and how this effect comes naturally into play when the beamformer is subjected to linear steering vector errors caused by lateral undersampling. This observation is something which has been missing in the literature on Capon beamforming for medical ultrasound imaging. The reason could be that researchers have focused more on the theoretical aspects of Capon beamforming than on the practical aspects of ultrasound imaging. A lack of studies where Capon beamforming is performed on consecutive frames might also explain the lack of discussions on this theme. Fortunately, as shown in \textbf{Paper\,III}, it is possible to maintain the same acquisition frame rate as for DAS beamforming by applying oversampling on receive using a set of steering vectors (phase delays). It also turns out that more matrix inversions are not needed either. Oversampling on receive will, however,  increase the penalty of applying post-processing, like filtering,  on polar-grid data. %The time taken to convert data from a polar scan grid to a Cartesian display grid will also increase. The Cartesian grid should also have high resolution in order to preserve the un-sharpening introduced by Capon beamforming. 

As just mentioned in the discussion of \textbf{Paper\,II}, reduced signal cancellation should prevent contrast from degrading to less than the contrast obtained with DAS beamforming. %It will, however,  not correct for signal cancellation caused by phase aberrations. At best it will correct for the linear term introduced by the aberrator if the term is small.
With improved shift invariance it will also be interesting to see if high-resolution beamforming could act as a post-processing step for other algorithms, for example to increase the precision of speckle and edge tracking. In the case where the image is generated for post processing it does not need to be visually pleasant anymore, as long as signal cancellation is avoided and the shift-invariance property is maintained. DAS-like speckle has been the driving force behind many of the robustification techniques and the default parameters seen in the literature. Hence, more aggressive parameters might be used if the image produced is intended as input to another algorithm and not for the human eye.

\subsection{Paper\,IV}
%Objections to \textbf{Paper\,IV} includes its inherent chicken-or-egg dilemma. The visualization is adjusted based on the data acquired by a user. The user sees the visualization and adjust scanning based on the visual input. This recursive behavior suggest that the method is best suited for post-processing when data has been recorded and saved. 
%Does data need to be saved in order to perform tracking?
One limitation of the algorithm described in \textbf{Paper\,IV} is its dependence on a successful tracking. If the tracking fails, then the proposed method will fail.  Another issue is the view-dependent visibility, where an object could become visible or disappear while rotating or if the local statistics change a lot during the cardiac cycle. Even if the method successfully removes noise, this means that the rendering will become non-intuitive to interact with and unrealistic to watch. However, the method could still be used to clean up still images of standard cardiac views. 

The paper does also propose an interesting method for automatic tuning of rendering parameters. Figure \ref{fig:vis}d in \textbf{Paper\,IV} actually shows that an optimal threshold could be found based on global and not only local statistics. Even though the visualization based on global statistics has more errors with respect to endocardium visibility, the tuning of the opacity function is still automatic if an iterative search for the minima in Fig.\,\ref{fig:vis}d is performed. A global opacity transfer function will insure a rendering which is realistic, but it will still be dependent on a successful tracking for the auto-adjustment to work. 

An automatically tuned opacity transfer function based on global statistics combined with an improved smoothing scheme is likely to be better suited for cardiac ultrasound imaging than a local opacity transfer function. A local opacity transfer function is just too extreme to be clinically robust. 

For future work, it would also be interesting to see if statistics based on the weight vector selected by the Capon or the LCA beamformer could be utilized to control local opacity modulations. It should also be possible to use this statistic as input to image filtering. An adaptively selected weight vector will be symmetric in homogeneous regions, and left-right shifted close to tissue interfaces. In that way we can, with improved confident, apply less smoothing and higher opacity values at tissue interfaces. If this will be different than just looking at neighboring pixels in an edge-preserving image filter is to be seen.

\subsection{Paper\,V}
The fifth paper stands out from the other papers by not dealing with an adaptive processing technique. However, it is still centered around the topic of implementing algorithms for ultrasound imaging on the GPU. Ultrasound simulations are typically used for research and sometimes also to pre-calculate configurations of a given scan sequence, for instance to achieve a certain pressure in a given area. The continuous growth in computational power will in the future make it possible to evaluate a scan sequence on the fly. For example to improve the estimation of the mechanical and thermal index. It will also add improved interactivity to ultrasound simulation tools. 

Achieving higher processing speed for an excising algorithm by implementing it on a new architecture is not academically relevant in its own. A good analysis has to be given of how the algorithm was modified for the architecture, or how to utilize the gained speed. These are points we have tried to answer in both \textbf{Paper\,I}, \textbf{II},  \textbf{IV}, and \textbf{V}.  

In \textbf{Paper\,V} the increased speed made an interactive painting ultrasound simulation program feasible. As of January 2014 the simulator has been download 200 times and counting\footnote{folk.uio.no/jpaasen/huygens}. It also has close to a 1000 views on Youtube\footnote{youtube.com/watch?v=rLgsfskliJM}.

\section{Multimedia content}
In \textbf{Paper II} and \textbf{III} there will be references to several videos that can be accessed online\footnote{folk.uio.no/jpaasen/thesis}.

\section{Software}
Finally it is worth mentioning that the code for both the Capon beamformer\footnote{github.com/jpaasen/cos} and the ultrasound field simulator\footnote{github.com/jpaasen/hos} have been released under an open source license. 

\endinput