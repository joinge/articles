\section{Motivation}
A rapid development in computer game technology and accompanying programming languages have recently provided researchers with small personal super computers, comprised in a single graphics card (\nom{GPU}{Graphics Processing Unit}). The latest graphics cards\footnote{As of January 2014} from both \nom{Nvidia}{Graphics card producer} and \nom{AMD}{Graphics card producer} provides close to 6 T\nom{FLOPS}{Floating point operations per second} single precision and 1.5 TFLOPS double precision. For double precision this is more than the worlds most powerful supercomputer could provide in 1998.

This immense rise in computational power and programming flexibility gives new possibilities when designing ultrasound imaging systems. Algorithms which previously had to be implemented in hardware for performance reasons can now be implemented in software. And algorithms, either too complicated to implement in hardware, or though to be too computationally heavy for real-time use, becomes realizable. It is clear that high-performance programmable processors, like the GPU, already have and will continue to make future ultrasound imaging systems more flexible, cheaper to produce, and equipped with even more cutting-edge processing.

The Capon beamformer\footnote{The name ''Capon beamformer'' is due to work by J. Capon \todo{add citation} on seismic arrays \todo{Move to background.}}  is a good example of an algorithm which has been highly studied for the last decade for the application of medical ultrasound imaging \todo{cite papers}, but where the number of calculations was though to be too much for real time processing. No wonder, to achieve real-time processing for e.g. cardiac ultrasound imaging an effective processing rate of around 100 MFLOPS is required. This number, as explained in Background \ref{sec:adaptbf}, also grows with larger subarrays, more image pixels, and higher framerate requirements.  With modern GPUs these levels of processing are finally available within a single card.

\section{Aims of study}
The overall aim of this study has been to investigate the possibility of utilizing GPUs for advanced processing in an ultrasound imaging system. 

My main focus have been the Capon beamformer, and the problem of making this computationally intense algorithm available for real-time ultrasound imaging (\textbf{Paper\,I} and \textbf{II}). However, two additional methods were also explored. The first is adaptive volume rendering of cardiac ultrasound volumes (\textbf{Paper\,IV}) and the latter is simulation of dense ultrasound pressure fields (\textbf{Paper\,V}). Both share the property of being computationally heavy, but they also consist of many independent computations which is perfect for parallel GPU computing. 

Well on my way into the project, when a real-time Capon beamformer was realized, and loops of images for the first time were processed, new issues where discovered and had to be solved. This led me to a more theoretical study of the Capon beamformer (\textbf{Paper III}), with special attention on how to obtain high lateral resolution while preserving the important shift-invariant property of medical ultrasound imaging. Shift-invariant behavior is crucial if the method is ever to be applied for live scanning. 

%\subsubsection{Accelerate the Capon beamformer to facilitate real time imaging}

%\subsubsection{}

\section{Summary of papers}

\subsection{Paper I}
\textbf{An Optimised GPU Implementation of the MVDR Beamformer for Active Sonar Imaging}\\
J.\:I.\:Buskenes, \textbf{J.\:P.\:\AA{}sen}, C.-I.\:C.\:Nilsen and A.\:Austeng\\
{\it IEEE Transactions on Oceanic Engineering, submitted.}\\\\
The first paper describes in details how we mapped the Capon beamformer to GPU architecture. Even though the paper is written within the field of active \nom{sonar}{SOund Navigation And Ranging (usually under water)} imaging, the depicted implementation is applicable to a vast range of active imaging systems. A similar discussion for cardiac ultrasound imaging can be found in \textbf{Paper VI}.  Active sonar imaging typically differs from medical ultrasound imaging by a lower real-time requirement and fewer array elements. This makes it somewhat easier to reach our goal of real-time processing. 

The estimation of the spatial covariance matrix receives special attention in this study. In previous literature on Capon beamforming the matrix inversion has always been regarded as the most computationally complex piece. In this paper we show that estimation of the sample covariance matrix is actually the most complex part when spatial and temporal smoothing is included with common parameters. It is then shown how the arithmetic complexity of this estimation process can be reduced from cubic to square. Finally, we give an in-depth analysis of the arithmetic throughput on multiple platforms. The reported throughput of 1 Mpx/s on a high-end GPU is, as far as the authors know, enough to provide real-time processing for all known sonar scan sequences. However, the number of effective FLOPS is only 4 \% and 14 \% of the theoretical throughput of the target GPU for the solver and covariance estimator respectively.

\subsection{Paper II}
\textbf{Implementing Capon Beamforming on a GPU for Real-Time Cardiac Ultrasound Imaging}\\
\textbf{J.\:P.\:\AA{}sen}, J.\:I.\:Buskenes, C.-I.\:C\:Nilsen, A.\:Austeng and S.\:Holm\\
{\it IEEE Transactions on Ultrasonics, Ferroelectrics, and Frequency Control, vol. 61, no. 1, pp. \todo{add pages}, Jan. 2014.}\\\\
The second paper aims at achieving real-time Capon beamforming for cardiac ultrasound imaging. Such an implementation will facilitates further study of the method's \textit{in vivo} performance for this modality. This is something which has been sought for the past decade \todo{Add citations}. In \textbf{Paper I} we investigated arrays with no more than 32 elements. A linear array for cardiac ultrasound imaging typically has 64 or more elements. In \textbf{Paper VI}, which is summarized in \textbf{Paper II}, it is shown that our implementation from  \textbf{Paper I} does not reach the level of throughput required for real-time Capon beamforming of cardiac ultrasound imaging. The matrices that have to be inverted becomes to large, and the number of frames that needs to be processed per second is to many.

To reduce the matrix size we take, in this paper, advantage of the beamspace version of the Capon beamformer (\nom{BS-Capon}{Beamspace Capon beamforming}), and implement it on the GPU. For parameters previously derived to give similar performance for BS-Capon and element space Capon (\nom{ES-Capon}{Element Space Capon}), we show that real-time BS-Capon beamforming is feasible for cardiac ultrasound imaging. The reported processing throughput is able to keep up with the acquisition frame rate in a typical cardiac ultrasound imaging system equipped with 64 and 96 element linear arrays.  \textbf{Paper II} and \textbf{VI} also presents, for the first time, videos where the ES-Capon and BS-Capon beamformer have been applied on loops of simulated and \textit{in vivo} medical ultrasound images.

\subsection{Paper III}
\textbf{Capon Beamforming and Moving Objects - An Analysis of Lateral Shift-Invariance}\\
\textbf{J.\:P.\:\AA{}sen}, A.\:Austeng and S.\:Holm\\
{\it IEEE Transactions on Ultrasonics, Ferroelectrics, and Frequency Control, submitted.}\\\\
In the third paper we study the shift-invariant property of an imaging system based on the Capon beamformer. As mentioned, shift-invariant imaging is essential if the method is ever to be adopted. The paper was written based on observations of aliasing artifacts when imaging bright point scatterers \textit{in vitro} and in simulations. The points were observed to twinkle like stars in the sky. In earlier work on Capon beamforming for medical ultrasound imaging the real-time nature of ultrasound imaging has been ignored, and a large degree of oversampling on transmit has often been applied without comments. Oversampling on transmit is not an option if the imaging modality is used to image rapidly varying objects.

In this paper we investigate how the Capon beamforming achieves its super resolution, and how this makes it highly sensitive to differences between the assumed steering vector and the signal propagation vector. Earlier work, focusing on single images, has typically referred to this effect as speed-of-sound errors, but it also comes naturally into play when objects moves from frame to frame and the beam density is insufficient. With a narrowband and farfield model we show that the Capon beamformer suffers from beam-to-beam gain variations as large as 27 dB for parameters previously used to obtain high resolution medical ultrasound images.  To obtain the same lateral gain variations as with \nom{DAS}{Delay-and-sum beamforming} beamforming, 25 times oversampling is shown to be required. For broadband nearfield simulations the same gain variations are observed. Finally we show that the gain variation can be reduced, hence improved shift-invariance, by oversampling on receive using phase rotation steering. This without affecting the acquisition frame rate and with a minor increase in computationally complexity. The method is successfully applied on simulations and \textit{in vitro} phantom data.

\subsection{Paper IV}
\textbf{Adaptive Volume Rendering of Cardiac 3D Ultrasound Images - Utilizing Blood Pool Statistics}\\
\textbf{J.\:P.\:\AA{}sen}, E.\:Steen, G.\:Kiss, A.\:Thorstensen and S.\:I.\:Rabben\\
{\it Proc. SPIE Medical Imaging 2012, \todo{add pages}.}\\\\
The fourth paper propose an adaptive volume rendering method based on statistics derived from the blood pool of the left ventricle. Noise located in the blood pool tends to occlude cardiac tissue when rendered in 3D, and is often impossible to remove by adjusting global rendering parameters. This because ultrasound signals have high variability within blood as well as high variability within tissue, even when heavily smoothed. Delineated of the blood pool is done by a state estimation algorithm, capable of tracking the endocardium in real time. The final visualizations are compared, with respect to location of tissue, with the result from a state-of-the-art endocardium segmentation tool. The paper presents both quantitative and qualitative results supporting the method's improved capabilities of reducing tissue dropouts and spurious structures inside the blood pool, and by that maximizing the amount of visible endocardium tissue. The proposed method is implemented on a GPU which results in interactive frame rates.

\subsection{Paper V}
\textbf{Huygens on Speed: Interactive Simulation of Ultrasound Pressure Fields}\\
\textbf{J.\:P.\:\AA{}sen} and S.\:Holm\\
{\it Proc. IEEE Ultrasonics Symposium 2012 \todo{add pages}.}\\\\
The fifth paper presents an interactive simulations tool capable of simulating dense pressure fields from ultrasound arrays in real time. Simulation tools are heavily used both by researchers and probe manufactures in order to test out new algorithms and to deduce the performance of new arrays prior to manufacturing. Dense simulations are unfortunately inherently slow. The presented tool is based on Huygens' principle which describes diffraction caused by a slit as the super position of several point sources located inside the opening. Thus, the simulator works by accumulating the contribution from a collection of point sources in a set of observation points. This is the core engine of the simulator, and it is, in the context of this thesis, of course running on a GPU. How the source and observation points are laid out is up to the user. The simulator is provided with both a paint-like interface for interactive drawing of arrays, and a Matlab interface for precise scripting of array configurations. The main contributions in this paper is the increased performance of the GPU implementation compared with a CPU and Matlab\footnote{The Ultrasim toolbox \todo{add citation}} version. Second, the paint-like interface provides a neat way of demonstrating array beamforming principle in real time. We believe this will be of great value both for array designers and teachers.

\section{Discussion}
The main contributions of this thesis are:
\begin{enumerate}
\item a GPU implementation of the Capon beamformer
\item a GPU implementation of the beamspace Capon beamformer
\item that real-time beamspace Capon beamforming is achieved for cardiac ultrasound imaging
\item the first investigation of Capon beamforming applied on multiple frames in medical ultrasound imaging (simulated, \textit{in-vitro}, and \textit{in-vivo})
\item an investigation of shift-invariance when using the Capon beamformer
\item a method for improved shift-invariance of the Capon beamformer
\item a method for reduced blood-pool noise in volume renderings of cardiac ultrasound volumes
\item a GPU implementation of this adaptive volume rendering method
\item a GPU implementation of simple paint-like simulation tool for rapid visualization ultrasound pressure fields
\item several discussions on how to utilize the GPU for computationally intense algorithms for advanced ultrasound imaging 
\end{enumerate}

Even with all our effort in \textbf{Paper I} we were only able to achieve a fraction of the maximum throughput of the target GPU. This result shows how hard it is to reach the theoretical level of throughput, and that how close one can get is highly algorithm depended. It might be ways of improving these numbers, but both the solver and covariance estimation step consist of several points where fine granular synchronization and serialized steps are needed. This will restrict even the most fine tuned implementation from reaching the maximum throughput of the GPU. An interesting observation can be found in Fig.\,10 in \textbf{Paper I}. Here we see how the throughput of the covariance estimation kernel is more than three times higher than the theoretical throughput of a modern, high-end, \nom{CPU}{Central processing unit}. This clearly shows the benefit of modern GPU computing. 

Solving was done by a batched Gauss Jordan solver implemented by Nvidia. We decided to focus on the covariance estimation step, and did not try to beat Nvidia at home. Nevertheless, with the measured throughput in mind, a natural next step would be to analyze the current solver, and figure out if any further optimization is possible. Since the sample covariance matrix is hermitian, a solver based on Cholesky decomposition might also help to improve the solver's throughput.
\\\\
Paper2

Discuss why cardiac ultrasound is selected and if full Capon will be real-time for other modalities.

No detailed evaluation of \textit{in vivo} performance. In cardiac application it has been proven hard to transfer results obtained in simulations to \textit{in vivo}. The improvements given is minimal with respect to the amount of calculation required.
\\\\
Paper3
\\\\
Paper4
\\\\
Paper5

This is not an adaptive algorithm.

Mark that code for GPU-Capon and Huygens on speed have been made open source.
It has over 200 downloads and soon 1000 views on youtube.

\section{Conclusion}

Concluding remarks...

\section{Future work}

All five papers...

Integrated beamforming and visualization. Using adaptive beamforming to improve e.g. speckle tracking and segmentation. Use adaptive weight statistics to guide image smoothing.

\endinput